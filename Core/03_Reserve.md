# Push 예약 요청 API

## 1. 예약

- 예약 API 주소

  - **http(s)://`host`:`port`/message/reserve**
    - 내부망에서 운영되는 경우에는 https를 구축할 필요가 없지만 외부망으로 분리되어 운영되는 경우에는 https 구성을 이용하는 게 안전하다.
    - 서버의 주소(host, port)의 경우에는 운영환경에 맞는 값을 사용한다.

- 요청 샘플
  - HTTP 프로토콜을 이용하는 POST 요청으로 아래와 같은 형태로 요청한다.

```
POST /message/reserve HTTP/1.1
...
Accept: application/json, text/plain, */*
Content-Type: application/json;charset=UTF-8
...
app-key: 608efc0f8f9e8aa11caed834203d7e03bba2456824405310bf876ae8268375cc

{
    "timeZoneOffset":32400,
    "reserve":{
        "repeatType":1,
        "startDate":1630987694152,
        "endDate":1632960000000,
        "reserveDate":1630990800727,
        "weekDays":[],
        "days":[]
    },
    "target":{
        "userIds":["yjmoon"],
        "topic":null,
        "group":null
    },
    "message":{
        "title":"제목입니다.",
        "body":"내용입니다.",
        "image":null,
        "sound":null,
        "clickAction":null,
        "category":null,
        "customData":{},
        "ttl":86400,
        "priorityHigh":true
    }
}
```

- 요청 개요

  - POST 요청의 데이터는 모두 JSON 포맷으로 이루어진다. 샘플은 참고용이므로 값이 null인 필드들이 모두 표시되어 있지만 몇몇 필수 필드를 제외하고 모두 생략 가능하다.
  - 요청의 헤더에는 `app-key`가 반드시 포함되어 있어야 하며 관리자에게 문의하면 받을 수 있다.
  - 이미 지나간 시간에 대해서는 예약할 수 없으며 지정된 기간 내에 예약 가능한 시간이 하나도 없는 경우에도 예약이 되지 않는다.

- `timeZoneOffset`
  요청자의 Timezone Offset값을 초단위로 설정한다. 같은 시점이라도 Timezone에 따라서 날짜가 달라지므로 요청자의 Timezone을 기준으로 날짜를 계산하기 위함이다. 날짜의 기준이 되는 Timezone의 offset값을 지정하면 된다. 샘플의 경우에는 대한민국(+9시간) 기준 값이다.

- `reserve`
  예약 관련 정보를 담고있다.

  - `repeatType`: 예약 시간의 반복 방식을 지정한다.

    | 값  | 타입                      |
    | --- | ------------------------- |
    | 1   | 지정된 기간동안 매일 반복 |
    | 2   | 지정된 기간동안 매주 반복 |
    | 3   | 지정된 기간동안 매월 반복 |

  - `startDate`: 예약 시작일자. 1970. 1. 1 00:00 기준시 이후 경과된 millisecond 단위의 시간값이다. 시작 당일도 기간에 포함된다.

  - `endDate`: 예약 종료일자. 1970. 1. 1 00:00 기준시 이후 경과된 millisecond 단위의 시간값이다. 종료 당일도 기간에 포함된다. 따라서 startDate, endDate를 같은 날로 지정하고 '매일 반복'으로 예약하면 1회성 예약이 된다.

  - `reserveDate`: 예약 시간. 1970. 1. 1 00:00 기준시 이후 경과된 millisecond 단위의 시간값이다. 하지만 날짜 정보는 무시되며 **시간 정보만 유효**하다. 따라서 시간 정보만 정확하다면 어느 날짜의 값이라도 상관없다.

  - `weekDays`: repeatType 값이 2인 경우(매주 반복)인 경우 반드시 지정되어야 한다. 배열값으로 한 번에 여러 요일을 지정할 수 있다. 즉, 예약기간 동안 매주 지정된 요일에 푸시를 발송한다. 각 요일의 값은 아래와 같다. [0..6]

    | 값  | 요일   |
    | --- | ------ |
    | 0   | 월요일 |
    | 1   | 화요일 |
    | 2   | 수요일 |
    | 3   | 목요일 |
    | 4   | 금요일 |
    | 5   | 토요일 |
    | 6   | 일요일 |

  - `days`: repeatType 값이 3인 경우(매월 반복)인 경우 반드시 지정되어야 한다. 배열값으로 한 번에 여러 날짜를 지정할 수 있다. 즉, 예약기간 동안 매월 지정된 날짜에 푸시를 발송한다. [1..31]

- `target`
  메시지 발송 요청의 경우와 같으므로 '1. Push 발송 요청 API' 참조.

- `message`
  메시지 발송 요청의 경우와 같으므로 '1. Push 발송 요청 API' 참조.

## 2. 응답

- 응답 개요

  - HTTP 응답 코드가 200 OK인 경우 일단 요청 자체는 성공한 것이다.
  - 응답 코드가 200 이외의 값인 경우 모두 실패이며 app-key 헤더가 없거나 기타 이유로 HTTP 요청 자체가 실패할 수 있다.

- 응답 샘플
  200 OK를 받은 경우에도 응답에 포함된 `code` 값을 검사하여 실패 여부를 검사해야 한다. 실패한 경우 `message` 필드를 통해서 적당한 에러메시지를 받을 수 있다.

  - 성공

  ```
  {
    "code":0
  }
  ```

  - 실패

  ```
  {
    "code":-1,
    "message":"Invalid timezone offset."
  }
  ```

- `code`: 0보다 크거나 같은 경우 성공(일반적으로 0). 0 보다 작은 경우 실패.

| code | 사유                    |
| ---- | ----------------------- |
| 0    | 성공                    |
| -1   | 기타 실패. 메시지 참고. |
| -2   | 타겟이 유효하지 않음    |
| -3   | DB Access 에러          |

- `message`: 코드값이 실패인 경우 실패 원인에 대한 메시지를 갖는다. 특별한 포맷은 없으며 에러 추적을 위한 시스템 메시지를 포함하는 경우도 있으므로 로그 기록 이외의 용도로는 부적합하다.
