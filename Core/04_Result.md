# Push 전송 결과/상태 조회 API

## 1. 결과/상태 조회

- 결과/상태 조회 API 주소

  - **http(s)://`host`:`port`/message/result**
    - 내부망에서 운영되는 경우에는 https를 구축할 필요가 없지만 외부망으로 분리되어 운영되는 경우에는 https 구성을 이용하는 게 안전하다.
    - 서버의 주소(host, port)의 경우에는 운영환경에 맞는 값을 사용한다.

- 요청 샘플
  - HTTP 프로토콜을 이용하는 POST 요청으로 아래와 같은 형태로 요청한다.

```
POST /message/result HTTP/1.1
...
Accept: application/json, text/plain, */*
Content-Type: application/json;charset=UTF-8
...
app-key: 608efc0f8f9e8aa11caed834203d7e03bba2456824405310bf876ae8268375cc

{
    "requestUids": [294, 295]
}
```

- 요청 개요

  - POST 요청의 데이터는 모두 JSON 포맷으로 이루어진다.
  - 요청의 헤더에는 `app-key`가 반드시 포함되어 있어야 하며 관리자에게 문의하면 받을 수 있다.

- `requestUids`
  `/message/send` 요청의 결과로 받은 requestUid를 전달한다. 단 1건만 요청을 하더라도 배열 형태로 전달해야 한다.

## 2. 응답

- 응답 개요

  - HTTP 응답 코드가 200 OK인 경우 일단 요청 자체는 성공한 것이다.
  - 응답 코드가 200 이외의 값인 경우 모두 실패이며 app-key 헤더가 없거나 기타 이유로 HTTP 요청 자체가 실패할 수 있다.

- 응답 샘플
  200 OK를 받은 경우에도 응답에 포함된 `code` 값을 검사하여 실패 여부를 검사해야 한다. 실패한 경우 `message` 필드를 통해서 적당한 에러메시지를 받을 수 있다.

  - 성공

  ```
  {
    "code": 0,
    "results": [
      {
        "token": "fsISbGX8TOaqTMXRS4cdop:APA91bFsZ79gzQq6eVUUbnlPy47Toqtn36YOkI9EjPion1hzMkg7IxJx13QC3gN-PLG7A-L23bYNhgL05LcBIhd6BEUGyY1RNjrprI-FL4mYepd1Ep8hCho3iBknJ4Qd9y0e0kbhriAG",
        "requestDate": "2022-03-08T07:52:19.208+00:00",
        "requestUid": 294,
        "pushId": "0:1646725940157726%bf0d2b77bf0d2b77",
        "resCode": 3,
        "resDate": "2022-03-08T07:52:27.002+00:00"
      },
      {
        "topic": "__everyone__",
        "requestDate": "2022-03-08T07:52:51.641+00:00",
        "requestUid": 295,
        "pushId": "74062896905141758",
        "resCode": 1,
        "resDate": "2022-03-08T07:52:53.248+00:00"
      }
    ]
  }
  ```

  - 실패

  ```
  {
    "code":-4,
    "msg":"Check the request data fields."
  }
  ```

- 응답 필드

  - `code`: 0보다 크거나 같은 경우 성공(일반적으로 0). 0 보다 작은 경우 실패.

    | code | 사유                        |
    | ---- | --------------------------- |
    | 0    | 성공                        |
    | -1   | 기타 실패. 메시지 참고.     |
    | -2   | 타겟이 유효하지 않음        |
    | -3   | 요청 데이터가 유효하지 않음 |
    | -4   | DB Access 에러              |

  - `message`: 코드값이 실패인 경우 실패 원인에 대한 메시지를 갖는다. 특별한 포맷은 없으며 에러 추적을 위한 시스템 메시지를 포함하는 경우도 있으므로 로그 기록 이외의 용도로는 부적합하다.
  - `results`: 배열 형태로 조회 결과를 갖는다. 각 요소 항목은 아래 필드를 갖는다.

    - `token`: 특정 토큰을 대상으로 전송 요청을 한 경우 타겟의 토큰값이다.
    - `topic`: 특정 토픽을 대상으로 전송 요청을 한 경우 타켓의 토픽값이다.
    - `requestDate`: 전송 요청 일시.
    - `requestUid`: /message/send 요청의 결과로 받은 요청 ID 값. 아래 pushId와는 다른 값이며 요청이 접수되면 발급되는 값이다.
    - `pushId`: FCM으로 실제 Push 전송 요청을 한 후 결과로 받은 Push ID.
    - `resCode`: 요청의 현재 상태값.

      | resCode | 상태                                                                                                                |
      | ------- | ------------------------------------------------------------------------------------------------------------------- |
      | 0       | 전송 **요청 실패**                                                                                                  |
      | 1       | 전송 **요청 성공**                                                                                                  |
      | 2       | **수신**. 단말 앱까지 전달된 상태이며 단말 시스템까지만 전달된 상태는 '**수신**'이 아니다.                          |
      | 3       | **수신 확인**. 사용자가 시스템의 알림을 클릭하여 확인한 상태. 클릭을 하지 않으면 '수신 확인 상태로 전환되지 않는다. |

    - `resDate`: 위 상태값이 마지막으로 업데이트된 시간. 수신 확인 업데이트는 사용자의 액션에 의한 상태 변경이므로 발송 시간과는 아무런 상관이 없다.
